"""
Web Application Vulnerability Scanner
Detects XSS, SQLi, CSRF, and other OWASP Top 10 vulnerabilities
"""
import requests
import re
from urllib.parse import urljoin, urlparse
from bs4 import BeautifulSoup
from datetime import datetime
import json
from typing import Dict, List, Tuple

class VulnerabilityScanner:
    """Core vulnerability scanner with payload injection and pattern matching"""
    
    def __init__(self, target_url: str, timeout: int = 10):
        self.target_url = target_url
        self.timeout = timeout
        self.vulnerabilities = []
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })
        
    # XSS Payloads and Patterns
    XSS_PAYLOADS = [
        '<script>alert("XSS")</script>',
        '"><script>alert("XSS")</script>',
        "';alert('XSS');//",
        '<img src=x onerror=alert("XSS")>',
        '<svg onload=alert("XSS")>',
        'javascript:alert("XSS")',
        '<iframe src=javascript:alert("XSS")>',
        '<body onload=alert("XSS")>',
    ]
    
    # SQLi Payloads
    SQLI_PAYLOADS = [
        "' OR '1'='1",
        "' OR 1=1--",
        "' OR 1=1/*",
        "admin' --",
        "1' UNION SELECT NULL--",
        "' AND '1'='1",
        "' AND SLEEP(5)--",
        "1' AND SLEEP(5)--",
    ]
    
    # CSRF Test Payloads
    CSRF_PAYLOADS = [
        '<img src="http://attacker.com/csrf?action=delete">',
        '<form action="{url}" method="POST" id="csrf"><input name="action" value="delete"></form><script>document.getElementById("csrf").submit()</script>',
    ]
    
    # Patterns for detection
    PATTERNS = {
        'xss': [
            r'<script[^>]*>.*?</script>',
            r'on\w+\s*=\s*["\']?[^"\']*["\']?',
            r'javascript:',
            r'<iframe[^>]*>',
            r'<embed[^>]*>',
            r'<object[^>]*>',
        ],
        'sqli': [
            r'SQL syntax',
            r'SQL error',
            r'database error',
            r'mysql_fetch',
            r'ORA-\d+',
            r'postgresql error',
            r'ODBC error',
        ],
        'csrf': [
            r'<form[^>]*method\s*=\s*["\']?post["\']?[^>]*>(?!.*csrf)',
        ],
    }
    
    def crawl_forms(self) -> List[Dict]:
        """Crawl target URL and extract all input forms"""
        forms_data = []
        try:
            response = self.session.get(self.target_url, timeout=self.timeout)
            response.raise_for_status()
            soup = BeautifulSoup(response.content, 'html.parser')
            
            forms = soup.find_all('form')
            for idx, form in enumerate(forms):
                form_data = {
                    'id': idx,
                    'action': form.get('action', self.target_url),
                    'method': form.get('method', 'GET').upper(),
                    'inputs': [],
                    'has_csrf_token': False,
                }
                
                # Extract input fields
                inputs = form.find_all(['input', 'textarea', 'select'])
                for inp in inputs:
                    field_name = inp.get('name', 'unnamed')
                    field_type = inp.get('type', 'text')
                    
                    if 'csrf' in field_name.lower() or 'token' in field_name.lower():
                        form_data['has_csrf_token'] = True
                    
                    form_data['inputs'].append({
                        'name': field_name,
                        'type': field_type,
                        'value': inp.get('value', ''),
                    })
                
                forms_data.append(form_data)
                
        except requests.RequestException as e:
            self.log_vulnerability('CRAWL_ERROR', f'Error crawling target: {str(e)}', 'CRITICAL')
            
        return forms_data
    
    def test_xss(self, url: str, params: Dict) -> List[Dict]:
        """Test for XSS vulnerabilities"""
        xss_vulns = []
        
        for payload in self.XSS_PAYLOADS:
            test_params = params.copy()
            
            # Test each parameter with XSS payload
            for key in test_params:
                test_params[key] = payload
                
                try:
                    response = self.session.get(url, params=test_params, timeout=self.timeout)
                    
                    # Check if payload is reflected in response
                    if payload in response.text or self._check_xss_patterns(response.text):
                        xss_vulns.append({
                            'parameter': key,
                            'payload': payload,
                            'type': 'Reflected XSS',
                            'evidence': response.text[:500],
                        })
                        
                except requests.RequestException:
                    pass
        
        return xss_vulns
    
    def test_sqli(self, url: str, params: Dict) -> List[Dict]:
        """Test for SQL Injection vulnerabilities"""
        sqli_vulns = []
        
        for payload in self.SQLI_PAYLOADS:
            test_params = params.copy()
            
            for key in test_params:
                test_params[key] = payload
                
                try:
                    response = self.session.get(url, params=test_params, timeout=self.timeout)
                    
                    # Check for SQL error patterns
                    if self._check_sqli_patterns(response.text) or response.status_code == 500:
                        sqli_vulns.append({
                            'parameter': key,
                            'payload': payload,
                            'type': 'SQL Injection',
                            'evidence': response.text[:500],
                            'status_code': response.status_code,
                        })
                        
                except requests.RequestException:
                    pass
        
        return sqli_vulns
    
    def test_csrf(self, forms: List[Dict]) -> List[Dict]:
        """Test for CSRF vulnerabilities"""
        csrf_vulns = []
        
        for form in forms:
            if form['method'] in ['POST', 'PUT', 'DELETE']:
                # Check if form lacks CSRF token
                if not form['has_csrf_token']:
                    csrf_vulns.append({
                        'form_id': form['id'],
                        'method': form['method'],
                        'action': form['action'],
                        'type': 'Missing CSRF Token',
                        'severity': 'HIGH',
                        'description': f'Form {form["id"]} with {form["method"]} method lacks CSRF token protection',
                    })
        
        return csrf_vulns
    
    def test_security_headers(self) -> List[Dict]:
        """Test for missing security headers"""
        header_vulns = []
        required_headers = {
            'X-Content-Type-Options': 'Prevents MIME-sniffing attacks',
            'X-Frame-Options': 'Prevents clickjacking attacks',
            'Strict-Transport-Security': 'Enforces HTTPS',
            'Content-Security-Policy': 'Prevents XSS attacks',
            'X-XSS-Protection': 'Browser XSS filter',
        }
        
        try:
            response = self.session.get(self.target_url, timeout=self.timeout)
            response_headers = response.headers
            
            for header, description in required_headers.items():
                if header not in response_headers:
                    header_vulns.append({
                        'header': header,
                        'type': 'Missing Security Header',
                        'description': description,
                        'severity': 'MEDIUM',
                    })
                    
        except requests.RequestException as e:
            self.log_vulnerability('HEADER_TEST_ERROR', str(e), 'CRITICAL')
        
        return header_vulns
    
    def scan_target(self, test_xss: bool = True, test_sqli: bool = True, 
                   test_csrf: bool = True, test_headers: bool = True) -> Dict:
        """Execute complete vulnerability scan"""
        scan_results = {
            'target': self.target_url,
            'scan_time': datetime.now().isoformat(),
            'vulnerabilities': [],
            'summary': {
                'total': 0,
                'critical': 0,
                'high': 0,
                'medium': 0,
                'low': 0,
            }
        }
        
        # Crawl and get forms
        forms = self.crawl_forms()
        
        # Test CSRF
        if test_csrf:
            csrf_vulns = self.test_csrf(forms)
            for vuln in csrf_vulns:
                self._add_vulnerability(vuln, scan_results)
        
        # Test security headers
        if test_headers:
            header_vulns = self.test_security_headers()
            for vuln in header_vulns:
                self._add_vulnerability(vuln, scan_results)
        
        # Test GET parameters for XSS and SQLi
        if test_xss or test_sqli:
            test_params = {'test': 'value', 'id': '1'}
            
            if test_xss:
                xss_vulns = self.test_xss(self.target_url, test_params)
                for vuln in xss_vulns:
                    vuln['severity'] = 'HIGH'
                    self._add_vulnerability(vuln, scan_results)
            
            if test_sqli:
                sqli_vulns = self.test_sqli(self.target_url, test_params)
                for vuln in sqli_vulns:
                    vuln['severity'] = 'CRITICAL'
                    self._add_vulnerability(vuln, scan_results)
        
        return scan_results
    
    def _check_xss_patterns(self, content: str) -> bool:
        """Check content for XSS patterns"""
        for pattern in self.PATTERNS['xss']:
            if re.search(pattern, content, re.IGNORECASE):
                return True
        return False
    
    def _check_sqli_patterns(self, content: str) -> bool:
        """Check content for SQL error patterns"""
        for pattern in self.PATTERNS['sqli']:
            if re.search(pattern, content, re.IGNORECASE):
                return True
        return False
    
    def _add_vulnerability(self, vuln: Dict, scan_results: Dict):
        """Add vulnerability to results and update severity counts"""
        severity = vuln.get('severity', 'MEDIUM')
        scan_results['vulnerabilities'].append(vuln)
        scan_results['summary']['total'] += 1
        scan_results['summary'][severity.lower()] += 1
    
    def log_vulnerability(self, vuln_type: str, description: str, severity: str = 'MEDIUM'):
        """Log vulnerability for reporting"""
        self.vulnerabilities.append({
            'type': vuln_type,
            'description': description,
            'severity': severity,
            'timestamp': datetime.now().isoformat(),
        })
    
    def export_report(self, scan_results: Dict, format: str = 'json') -> str:
        """Export scan results as JSON or HTML"""
        if format == 'json':
            return json.dumps(scan_results, indent=2)
        return str(scan_results)
